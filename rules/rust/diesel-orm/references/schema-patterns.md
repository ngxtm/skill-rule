# Diesel Schema Patterns

## Schema Definition

```rust
// schema.rs (generated by diesel)
diesel::table! {
    users (id) {
        id -> Int4,
        name -> Varchar,
        email -> Varchar,
        active -> Bool,
        created_at -> Timestamp,
    }
}

diesel::table! {
    posts (id) {
        id -> Int4,
        title -> Varchar,
        body -> Text,
        user_id -> Int4,
        published -> Bool,
    }
}

diesel::joinable!(posts -> users (user_id));
diesel::allow_tables_to_appear_in_same_query!(users, posts);
```

## Models

```rust
use diesel::prelude::*;
use crate::schema::users;

#[derive(Queryable, Selectable, Debug)]
#[diesel(table_name = users)]
pub struct User {
    pub id: i32,
    pub name: String,
    pub email: String,
    pub active: bool,
    pub created_at: chrono::NaiveDateTime,
}

#[derive(Insertable)]
#[diesel(table_name = users)]
pub struct NewUser<'a> {
    pub name: &'a str,
    pub email: &'a str,
}

#[derive(AsChangeset)]
#[diesel(table_name = users)]
pub struct UpdateUser<'a> {
    pub name: Option<&'a str>,
    pub email: Option<&'a str>,
    pub active: Option<bool>,
}
```

## CRUD Operations

```rust
use diesel::prelude::*;
use crate::schema::users::dsl::*;

// Create
fn create_user(conn: &mut PgConnection, user_name: &str, user_email: &str) -> QueryResult<User> {
    let new_user = NewUser {
        name: user_name,
        email: user_email,
    };

    diesel::insert_into(users)
        .values(&new_user)
        .returning(User::as_returning())
        .get_result(conn)
}

// Read
fn find_user(conn: &mut PgConnection, user_id: i32) -> QueryResult<Option<User>> {
    users.find(user_id).first(conn).optional()
}

fn list_active_users(conn: &mut PgConnection) -> QueryResult<Vec<User>> {
    users
        .filter(active.eq(true))
        .order(name.asc())
        .limit(10)
        .load(conn)
}

// Update
fn update_user(conn: &mut PgConnection, user_id: i32, new_name: &str) -> QueryResult<User> {
    diesel::update(users.find(user_id))
        .set(name.eq(new_name))
        .returning(User::as_returning())
        .get_result(conn)
}

fn update_user_partial(conn: &mut PgConnection, user_id: i32, changes: &UpdateUser) -> QueryResult<User> {
    diesel::update(users.find(user_id))
        .set(changes)
        .returning(User::as_returning())
        .get_result(conn)
}

// Delete
fn delete_user(conn: &mut PgConnection, user_id: i32) -> QueryResult<usize> {
    diesel::delete(users.find(user_id)).execute(conn)
}
```

## Associations

```rust
use diesel::prelude::*;

#[derive(Queryable, Identifiable, Selectable)]
#[diesel(table_name = users)]
pub struct User {
    pub id: i32,
    pub name: String,
}

#[derive(Queryable, Identifiable, Selectable, Associations)]
#[diesel(belongs_to(User))]
#[diesel(table_name = posts)]
pub struct Post {
    pub id: i32,
    pub title: String,
    pub user_id: i32,
}

fn posts_for_user(conn: &mut PgConnection, user: &User) -> QueryResult<Vec<Post>> {
    Post::belonging_to(user)
        .select(Post::as_select())
        .load(conn)
}

fn users_with_posts(conn: &mut PgConnection) -> QueryResult<Vec<(User, Vec<Post>)>> {
    let all_users = users::table.load::<User>(conn)?;
    let all_posts = Post::belonging_to(&all_users)
        .select(Post::as_select())
        .load(conn)?;
    
    Ok(all_posts.grouped_by(&all_users)
        .into_iter()
        .zip(all_users)
        .map(|(posts, user)| (user, posts))
        .collect())
}
```

## Connection Pool

```rust
use diesel::r2d2::{ConnectionManager, Pool};

type DbPool = Pool<ConnectionManager<PgConnection>>;

fn establish_pool(database_url: &str) -> DbPool {
    let manager = ConnectionManager::<PgConnection>::new(database_url);
    Pool::builder()
        .max_size(10)
        .build(manager)
        .expect("Failed to create pool")
}

// Usage
let pool = establish_pool("postgres://localhost/mydb");
let mut conn = pool.get().expect("Failed to get connection");
let users = list_active_users(&mut conn)?;
```

## Migrations

```bash
# Install CLI
cargo install diesel_cli --no-default-features --features postgres

# Setup
diesel setup

# Create migration
diesel migration generate create_users

# Run migrations
diesel migration run

# Revert
diesel migration revert
```

```sql
-- migrations/00000000000000_create_users/up.sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR NOT NULL,
    email VARCHAR NOT NULL UNIQUE,
    active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```
